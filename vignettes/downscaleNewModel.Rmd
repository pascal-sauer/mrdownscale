---
title: "How to downscale data from a new model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to downscale data from a new model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## starting point
You have regional (i.e non-gridded) land use data produced by an integrated assessment
model (we use "yourmodel" as placeholder name here) that should be harmonized and
downscaled to one of the high resolution reference/target datasets currently
available in mrdownscale: LUH3, LUH2v2h, landuseinit (MAgPIE initialization data)

It is assumed that data from yourmodel was not processed in mrdownscale
before (currently MAgPIE, WITCH, COFFEE are already supported). This tutorial
describes how to modify mrdownscale to process yourmodel data, but does
not cover harmonization or downscaling of nonland variables like fertilizer, even
though mrdownscale is capable of handling those (implemented for MAgPIE).

## requirements/preparation
- yourmodel dataset file (in a format R can read)
- region mapping (from country/gridcell to region)
- install R: https://cran.rstudio.com/
- install mrdownscale incl. dependencies, pkgload for development:
```{r, echo = TRUE, eval = FALSE}
options(repos = c(runiverse = "https://pik-piam.r-universe.dev",
                  CRAN = "https://cran.rstudio.com/"))
install.packages(c("mrdownscale", "pkgload"))
```

## integrating into mrdownscale
Currently mrdownscale itself needs to be modified to integrate a new model.
To do so, we recommend creating a fork of the
[mrdownscale repo](https://github.com/pik-piam/mrdownscale), then clone
your fork to a folder on your local machine. Apply the changes explained
in the following sections in that folder. To test your changes, always start
a fresh R session (!) in that folder and run `pkgload::load_all()` to
load your local mrdownscale directly from the source files.

To get an overview what changes are needed check
[this PR](https://github.com/pik-piam/mrdownscale/pull/38) which enabled
mrdownscale to process data from the COFFEE model.

### reference mapping
create map from non-overlapping land variable names to fine reference variables
link to other documentation that explains how category remapping works

### read/correct/convert
reference madrat vignette
read in data

### calcLandInput
ensure values >= 0, not NA/missing
ensure non-overlapping categories
ensure total area is constant over time (might need to add "rest" variable)
convert to magclass
variable names must match those in reference mapping

### calcResolutionMapping
based on your region mapping, create mapping between regional level and target grid level

### toolLandCategoriesMapping
add yourmodel to if-else like the other models

## running harmonization and downscaling
```{r, echo = TRUE, eval = FALSE}
calcOutput("LandHarmonized")
retrieveData("SCENARIOMIP", input = "yourmodel")
```
