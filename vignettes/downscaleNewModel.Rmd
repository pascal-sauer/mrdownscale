---
title: "How to downscale data from a new model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to downscale data from a new model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## starting point
You have regional (i.e non-gridded) land use data produced by an integrated assessment
model (we use "yourmodel" as placeholder name here) that should be harmonized and
downscaled using LUH3 as historical high resolution reference dataset.

This tutorial describes how to modify mrdownscale to process yourmodel data, but does
not cover harmonization or downscaling of nonland variables like fertilizer, even
though mrdownscale is capable of handling those (implemented for MAgPIE).

## requirements/preparation
- yourmodel dataset file (in a format R can read)
- region mapping (from country/gridcell to region)
- install R: https://cran.rstudio.com/
- install mrdownscale incl. dependencies, pkgload for development:
```{r, echo = TRUE, eval = FALSE}
options(repos = c(runiverse = "https://pik-piam.r-universe.dev",
                  CRAN = "https://cran.rstudio.com/"))
install.packages(c("mrdownscale", "pkgload"))
```

## integrating into mrdownscale
Currently mrdownscale itself needs to be modified to integrate a new model.
To do so, we recommend creating a fork of the
[mrdownscale repo](https://github.com/pik-piam/mrdownscale), then clone
your fork to a folder on your local machine. Apply the changes explained
in the following sections in that folder. To test your changes, always start
a fresh R session (!) in that folder and run `pkgload::load_all()` to
load your local mrdownscale directly from the source files.

To get an overview what changes are needed check
[this PR](https://github.com/pik-piam/mrdownscale/pull/38) which enabled
mrdownscale to process data from the COFFEE model.

### reference mapping
To map from yourmodel variables to the variables of any of the supported
target datasets a mapping from yourmodel variables to fine reference variables
is needed. In case yourmodel variables do not cover the entire land
area (e.g. if urban is missing) add a variable called "rest". Put your mapping
csv file into inst/extdata/referenceMappings. In that folder look into
coffee.csv to see how it should look like.
For more details on how the variable mapping works check
[this](https://github.com/pik-piam/mrdownscale/blob/main/R/calcLandInputRecategorized.R).

### read/correct/convert
mrdownscale uses the madrat framework, if you want to learn more about madrat check this
[vignette](https://pik-piam.r-universe.dev/articles/madrat/madrat.html). Reading that
vignette should not be necessary to follow this tutorial though.
read in data

### calcLandInput
ensure values >= 0, not NA/missing
ensure non-overlapping categories
ensure total area is constant over time (might need to add "rest" variable)
convert to magclass
variable names must match those in reference mapping

### calcResolutionMapping
based on your region mapping, create mapping between regional level and target grid level

### toolLandCategoriesMapping
add yourmodel to if-else like the other models

## running harmonization and downscaling
```{r, echo = TRUE, eval = FALSE}
calcOutput("LandHarmonized")
retrieveData("SCENARIOMIP", input = "yourmodel")
```
